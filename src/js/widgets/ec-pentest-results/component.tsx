import { useTranslation } from "@opendash/core";
import { createWidgetComponent } from "@opendash/plugin-monitoring";
import { useDataService } from "@opendash/plugin-timeseries";
import { Empty } from "antd";
import dayjs from "dayjs";
import { EChartsOption } from "echarts";
import ReactECharts from "echarts-for-react";
import * as React from "react";
import { ConfigInterface, SeriesDataType } from "./types";

export default createWidgetComponent<ConfigInterface>(
  ({ config, ...context }) => {
    const t = useTranslation();
    const DataService = useDataService();
    const { width, height } = context.useContainerSize();
    const margin = [150, 80];
    const name = context
      .useItemDimensionConfig()
      .map(([item, dimension]) => DataService.getItemName(item, dimension))
      .join(", ");

    const dimensionsForYAxis = Array.from(
      new Set(
        context
          .useItemDimensionConfig()
          .map(([item, dimension]) => item.valueTypes)
          .flat()
      )
    );

    context.setName(
      t("echarts:pentestresults.graph.name", {
        name: name,
      })
    );

    const chartConfig: EChartsOption = context.useFetchDimensionValues(
      {},
      (history) => {
        console.log(history);

        const timesForXAxis = Array.from(
          new Set(history.map((item) => item[2].map((d) => d.date)).flat())
        ).sort();

        const data: SeriesDataType[] = history
          .map((item, itemIndex) => {
            return item[2]
              .filter((d) => d.value !== undefined && d.value.length !== 0)
              .map((d, i): SeriesDataType => {
                return {
                  id: `pentestresult-${itemIndex}-${d.date}-${i}`,
                  name: d.value,
                  value: [
                    timesForXAxis.indexOf(d.date), // x coordinate
                    dimensionsForYAxis.findIndex(
                      // y coordinate
                      (dim) => dim.name === item[0].valueTypes[item[1]].name
                    ),
                  ],
                };
              });
          })
          .flat();

        console.log(data);

        return {
          title: {
            text: t("echarts:pentestresult.title"),
          },
          xAxis: {
            type: "category",
            data: timesForXAxis.map((d) =>
              dayjs(new Date(d)).format("DD.MM.YY HH:mm")
            ),
            axisLabel: {
              color: "#555",
              fontSize: 12,
              rotate: 45, // Rotate labels for better readability
            },
            name: t("echarts:pentestresult.xaxis.name"),
            nameLocation: "middle",
            nameGap: 80,
            nameTextStyle: {
              fontSize: 16,
              fontWeight: "bold",
              color: "#333",
            },
          },
          yAxis: {
            type: "category",
            data: dimensionsForYAxis.map(
              (d) =>
                `${d.name.toString() || "n/a"}${d.unit ? ` (${d.unit})` : ""}`
            ),
            axisLabel: {
              color: "#555",
              fontSize: 12,
            },
            name: t("echarts:pentestresult.yaxis.name"),
            nameLocation: "middle",
            nameGap: 120,
            nameTextStyle: {
              fontSize: 16,
              fontWeight: "bold",
              color: "#333",
            },
          },
          grid: {
            left: margin[1],
            right: margin[1],
            top: margin[0],
            bottom: margin[0],
            containLabel: true,
          },
          series: [
            {
              type: "scatter",
              symbolSize: 15,
              data: data,
              label: {
                show: true,
                formatter: (params) => {
                  return (params.data as SeriesDataType).name;
                },
                color: "#555",
                fontSize: 12,
                position: "top",
              },
              itemStyle: {
                color: "#ff6b6b",
                borderColor: "#333",
                borderWidth: 1,
              },
              emphasis: {
                scale: true,
                itemStyle: {
                  color: "#ff4757",
                },
              },
            },
          ],
        } as EChartsOption;
      },
      (item, dimension, value, index) => {}
    ) || { series: [] };

    context.setLoading(false);

    return (
      <>
        {typeof chartConfig !== "undefined" ? (
          <ReactECharts
            option={chartConfig}
            style={{ height: height, width: width }}
          />
        ) : (
          <Empty></Empty>
        )}
      </>
    );
  }
);
